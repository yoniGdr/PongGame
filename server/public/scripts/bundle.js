(()=>{"use strict";class t{constructor(t,e,i,s=0,h=0){this._y=e,this._x=t,this.img=new Image,this.img.src=i,this._shiftX=s,this._shiftY=h}get width(){return this.img.width}get height(){return this.img.height}move(){this.x=this.x+this.shiftX,this.y=this.y+this.shiftY}get y(){return this._y}get x(){return this._x}get shiftX(){return this._shiftX}get shiftY(){return this._shiftY}set x(t){this._x=t}set y(t){this._y=t}set shiftY(t){this._shiftY=t}set shiftX(t){this._shiftX=t}draw(t){t.drawImage(this.img,this.x,this.y)}stopMoving(){this.shiftX=0,this.shiftY=0}changeImg(t){this.img.src=t}}class e extends t{constructor(t,e,i,s=-8,h=0,a="./images/balle24.png",n=12){super(t,e,a,s,h),this.theGame=i,this.speed=n}move(){this.y<=0||this.y+this.height>=this.theGame.canvas.height?this.shiftY=-this.shiftY:this.x<=0?this.theGame.emitRoundWinner(!0):this.x+this.width>=this.theGame.canvas.width&&this.theGame.emitRoundWinner(!1),super.move()}collision(t){const e=Math.max(t.x,this.x),i=Math.max(t.y,this.y),s=t.x+t.width,h=t.y+t.height,a=Math.min(s,this.x+this.width),n=Math.min(h,this.y+this.height);if(!(e<a&&i<n))return;if(this.shiftX>0&&this.x+10>t.x)return;if(this.shiftX<0&&this.x-10<t.x)return;const l=this.y+this.height/2,o=-(t.y+t.height/2-l)/(t.height/10);this.shiftY=o,this.shiftX=this.shiftX>0?-(this.speed-Math.abs(o)):this.speed-Math.abs(o),this.theGame.handleBallCollision(this.x,this.y,this.shiftX,this.shiftY)}newRound(){this.x=this.theGame.canvas.width/2+this.width/2,this.y=this.theGame.canvas.height/2+this.height/2}}class i extends e{constructor(t,e,i,s=4,h=0){super(t,e,i,s,h,"./images/fire26-0.png",16),this.frame=0,setInterval((()=>{this.nextFrame()}),75)}nextFrame(){this.frame++,this.changeImg(`./images/fire26-${this.frame%16}.png`)}collision(t){const e=Math.max(t.x,this.x),i=Math.max(t.y,this.y),s=t.x+t.width,h=t.y+t.height,a=Math.min(s,this.x+this.width),n=Math.min(h,this.y+this.height);if(!(e<a&&i<n))return;if(this.shiftX>0&&this.x+10>t.x)return;if(this.shiftX<0&&this.x-10<t.x)return;const l=this.y-1+this.height/2,o=-(t.y+t.height/2-l)/(t.height/10);this.shiftY=o,this.shiftX=this.shiftX>0?-(this.speed-Math.abs(o)):this.speed-Math.abs(o),this.theGame.handleBallCollision(this.x,this.y,this.shiftX,this.shiftY)}}class s{static DOWN=0;static UP=1;static NONE=2;get DOWN(){return DOWN}get UP(){return UP}get NONE(){return NONE}}class h extends t{constructor(t,e,i){super(t,e,"./images/paddle.png",0,6),this.theGame=i,this.moving=s.NONE,this.points=0}up(){return this.moving===s.UP}down(){return this.moving===s.DOWN}moveUp(){this.shiftY=-Math.abs(this.shiftY),this.moving=s.UP}moveDown(){this.shiftY=Math.abs(this.shiftY),this.moving=s.DOWN}move(t){this.up()&&(this.y=Math.max(0,this.y+this.shiftY)),this.down()&&(this.y=Math.min(t.height-this.height,this.y+this.shiftY))}stopMoving(){this.moving=s.NONE}}class a{constructor(t,e){this.totalSeconds=60*e,this.timer,this.isOn=!1,this.theGame=t}startPauseTimer(){this.isOn?this.pauseTimer():this.start()}getMinutes(){return Math.floor(this.totalSeconds/60)}getSeconds(){let t=this.totalSeconds%60;return t<10?"0"+t:t}start(){this.isOn=!0,this.runTimer()}runTimer(){this.timer=setInterval((()=>{this.theGame.updateTimer(this.getMinutes()+":"+this.getSeconds()),this.tick()&&(this.theGame.gameOver(),clearInterval(this.timer))}),1e3)}tick(){return!(this.totalSeconds>0&&(this.totalSeconds--,1))}pauseTimer(){this.isOn=!1,clearInterval(this.timer)}}const n="./images/paddle_blue.png",l="./images/paddle_red.png";class o{constructor(t){this.raf=null,this._canvas=t,this.ball=new e(this.canvas.width-80,this.canvas.height/2,this),this.ball.newRound(),this.ball.x=this._canvas.width-80,this.ball.y=this._canvas.height/2+this.ball.height/2,this.paddleA=new h(this.canvas.width-50,this.canvas.height/2-20,this),this.paddleB=new h(28,this.canvas.height/2-20,this),this.gameOn=!1,this.scoreA=0,this.scoreB=0,this.player={user:localStorage.getItem("pong_username"),roomId:null,socketId:null,isPlayer1:!0,paddle:null},this.socket=null,this.handleConnection(),this.handleMovement(),this.shadowDelay=0,this.hotRoundFrame=0,this.justAddedPoints=!1,this.timer=new a(this,1),this.gameFinished=!1,this.canPlay=!1,this.canStart=!1,this.messages=document.getElementById("messages"),this.waiting=document.getElementById("players"),this.form=document.getElementById("form"),this.input=document.getElementById("input"),this.nextPlayer=null}gameStatus(){return this.gameOn}updateTimer(t){document.getElementById("timer").innerText=t}gameOver(){this.gameFinished=!0;const t=this.canvas.getContext("2d");if(t.font="100px Gameria",t.textAlign="center",t.fillStyle="#ef5b5b",this.scoreA==this.scoreB)return t.fillStyle="#FFD700",t.fillText("DRAW",this.canvas.width/2,this.canvas.height/2),t.fillStyle="black",t.font="50px Gameria",t.fillText("Click anywhere to play again",this.canvas.width/2,this.canvas.height-50),this.socket.emit("draw"),void window.cancelAnimationFrame(this.raf);this.scoreA>this.scoreB?this.player.isPlayer1?(t.fillStyle="#29a5ed",t.fillText("YOU WIN",this.canvas.width/2,this.canvas.height/2)):(t.fillText("YOU LOSE",this.canvas.width/2,this.canvas.height/2),this.socket.on("leave",(()=>{window.location.replace("out.html")}))):this.player.isPlayer1?(t.fillText("YOU LOSE",this.canvas.width/2,this.canvas.height/2),this.socket.on("leave",(()=>{window.location.replace("out.html")}))):(t.fillStyle="#29a5ed",t.fillText("YOU WIN",this.canvas.width/2,this.canvas.height/2)),this.socket.emit("gameOver"),t.fillStyle="black",t.font="50px Gameria",null!=this.nextPlayer?(t.fillText("Click anywhere to play against",this.canvas.width/2,this.canvas.height-60),t.fillStyle="#ef5b5b",t.fillText(this.nextPlayer,this.canvas.width/2,this.canvas.height-20)):t.fillText("Click anywhere to play again",this.canvas.width/2,this.canvas.height-50),window.cancelAnimationFrame(this.raf)}playAgain(){this.gameFinished&&location.reload()}get canvas(){return this._canvas}roundWinner(t){if(this.justAddedPoints)return;this.justAddedPoints=!0,this.shadowDelay=2,this.ball.shiftY=0,t?(this.scoreA++,this.ball.shiftX=6,this.canvas.style.boxShadow=this.player.isPlayer1?"5px 5px 30px #00cc66":"5px 5px 30px #e60000"):(this.ball.shiftX=-6,this.scoreB++,this.canvas.style.boxShadow=this.player.isPlayer1?"5px 5px 30px #e60000":"5px 5px 30px #00cc66"),this.paddleA.y=this.canvas.height/2-20,this.paddleB.y=this.canvas.height/2-20,this.ball=new e(this.ball.x,this.ball.y,this),this.ball.newRound(),this.hotRoundFrame=0;const i=setInterval((()=>{this.shadowDelay--,this.shadowDelay<=0&&(this.justAddedPoints=!1,this.canvas.style.boxShadow="",clearInterval(i))}),1e3)}emitRoundWinner(t){this.socket.emit("roundWinner event",t)}start(){this.gameFinished||(this.gameOn=!0,this.animate())}stop(){this.gameFinished||(this.gameOn=!1,this.canvas.getContext("2d").fillText("GAME PAUSED",this.canvas.width/2,this.canvas.height/2),window.cancelAnimationFrame(this.raf))}animate(){this.moveAndDraw(),this.raf=window.requestAnimationFrame(this.animate.bind(this)),this.hotRoundFrame++,700==this.hotRoundFrame&&(this.canvas.style.boxShadow="inset 5px 5px 30px #FFA500",this.ball=new i(this.ball.x,this.ball.y,this,this.ball.shiftX,this.ball.shiftY));const t=this.canvas.getContext("2d");t.fillStyle="black",t.font="50px Gameria",t.fillText(`${this.scoreB} - ${this.scoreA}`,this.canvas.width/2,50)}moveAndDraw(){const t=this.canvas.getContext("2d");t.clearRect(0,0,this.canvas.width,this.canvas.height),this.ball.move(),this.ball.collision(this.paddleA),this.ball.collision(this.paddleB),this.ball.draw(t),this.paddleA.move(this.canvas),this.paddleB.move(this.canvas),this.paddleA.draw(t),this.paddleB.draw(t)}startPause(){this.canPlay&&(this.gameOn?(this.stop(),this.timer.startPauseTimer(),document.getElementById("start").value="jouer"):(this.start(),this.timer.startPauseTimer(),document.getElementById("start").value="stop"))}keyDownActionHandler(t){switch(t.key){case"Escape":this.socket.emit("start");break;case" ":!this.canPlay&&this.canStart&&(this.socket.emit("ballSent event"),this.canPlay=!0);break;case"ArrowUp":case"Up":this.socket.emit("up",this.player.isPlayer1),this.player.paddle.moveUp();break;case"ArrowDown":case"Down":this.socket.emit("down",this.player.isPlayer1),this.player.paddle.moveDown();break;default:return}t.preventDefault()}keyUpActionHandler(t){switch(t.key){case"ArrowUp":case"Up":case"ArrowDown":case"Down":this.socket.emit("stop",this.player.isPlayer1,this.player.paddle.x,this.player.paddle.y),this.player.paddle.stopMoving();break;default:return}t.preventDefault()}handleConnection(){this.socket=io(),this.socket.on("connection",(()=>{this.socket.emit("joinPrivate")})),this.socket.on("canPlay",(()=>{this.canPlay=!0,this.player.isPlayer1&&this.socket.emit("start")})),this.socket.on("startGame",(()=>{this.startPause()})),this.socket.on("update_list",(t=>{this.waiting.innerText="";let e=null;const i=t.length;this.nextPlayer=i>=1?t[0]:null;for(let s=0;s<i;s++)e=document.createElement("li"),e.innerText=t[s],this.waiting.appendChild(e)})),this.socket.on("yourTurn",(()=>{location.reload()})),this.socket.on("connection_refused",(()=>{const t=this.canvas.getContext("2d");t.font="40px Gameria",t.textAlign="center",t.fillText("Oups, a game has already started.",this.canvas.width/2,this.canvas.height/2),t.font="30px Gameria",t.fillText("Wait until it's over.",this.canvas.width/2,this.canvas.height/2+50),this.socket.emit("joinWaiting",this.player.user)})),this.socket.on("private",(t=>{if(t){this.paddleA.changeImg(n),this.paddleB.changeImg(l),this.player.socketId=this.socket.id,this.player.paddle=this.paddleA,this.player.isPlayer1=!0,console.log("You are the Player 1"),document.getElementById("player").innerText=this.player.user;const t=this.canvas.getContext("2d");t.font="40px Gameria",t.textAlign="center",t.fillText("Waiting for Player 2",this.canvas.width/2,this.canvas.height/2),this.socket.on("canStart",(e=>{this.gameFinished||(this.moveAndDraw(),this.canStart=!0,t.font="40px Gameria",t.fillStyle="#ef5b5b",t.fillText(e,this.canvas.width/2,this.canvas.height/2),t.fillStyle="black",t.fillText("joined the game",this.canvas.width/2,this.canvas.height/2+50),t.fillText("Press space to send the ball",this.canvas.width/2,this.canvas.height-100))}))}else{const t=this.canvas.getContext("2d");t.font="40px Gameria",t.textAlign="center",this.paddleB.changeImg(n),this.paddleA.changeImg(l),this.player.paddle=this.paddleB,this.player.isPlayer1=!1,this.player.socketId=this.socket.id,console.log("You are the Player 2"),document.getElementById("player").innerText=this.player.user,this.moveAndDraw(),t.textAlign="center",t.fillText("Waiting for Player 1 to send the ball",this.canvas.width/2,this.canvas.height/2),this.socket.emit("canStart event",this.player.user)}})),this.socket.on("alone",(()=>{location.reload()})),this.socket.on("roundWinner",(t=>{this.roundWinner(t)})),document.getElementById("form").addEventListener("submit",(t=>{t.preventDefault(),this.input.value&&(this.socket.emit("chat message",this.player.user+" : "+this.input.value,this.player.socketId),this.input.value="")})),this.socket.on("chat message",((t,e)=>{const i=document.createElement("li");e==this.player.socketId?(i.style.color="#29a5ed",i.textContent=t):(i.style.color="#ef5b5b",i.textContent=t),this.messages.appendChild(i)}))}handleMovement(){this.socket.on("paddleUp",(t=>{!t&&this.player.isPlayer1&&this.paddleB.moveUp(),t&&!this.player.isPlayer1&&this.paddleA.moveUp()})),this.socket.on("paddleDown",(t=>{!t&&this.player.isPlayer1&&this.paddleB.moveDown(),t&&!this.player.isPlayer1&&this.paddleA.moveDown()})),this.socket.on("paddleStop",((t,e,i)=>{!t&&this.player.isPlayer1&&(this.paddleB.stopMoving(),this.paddleB.x=e,this.paddleB.y=i),t&&!this.player.isPlayer1&&(this.paddleA.stopMoving(),this.paddleA.x=e,this.paddleA.y=i)})),this.socket.on("ballMoved",((t,e,i,s)=>{this.ball.x=t,this.ball.y=e,this.ball.shiftX=i,this.ball.shiftY=s}))}handleBallCollision(t,e,i,s){this.socket.emit("ball",t,e,i,s)}}const r=document.getElementById("settings"),d=document.getElementById("popup"),c=document.getElementById("close"),m=document.getElementById("reset");r.addEventListener("click",(()=>{d.style.display="block"})),c.addEventListener("click",(()=>{d.style.display="none"})),m.addEventListener("click",(()=>{localStorage.clear()})),window.addEventListener("load",(()=>{if(null==localStorage.getItem("pong_username")){let t=prompt("Enter a username : ");for(;null==t||""==t;)t=prompt("Enter a username : ");localStorage.setItem("pong_username",t)}const t=document.getElementById("field"),e=new o(t);t.addEventListener("click",(()=>{e.playAgain()}),!1),document.getElementById("start").addEventListener("click",(()=>p())),window.addEventListener("keydown",e.keyDownActionHandler.bind(e)),window.addEventListener("keyup",e.keyUpActionHandler.bind(e))}));const p=()=>{window.dispatchEvent(new KeyboardEvent("keydown",{key:"Escape"}))}})();